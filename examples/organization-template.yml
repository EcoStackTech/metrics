name: EcoStack Metrics Collection Template
description: "Reusable workflow template for EcoStack metrics collection across the organization"
on:
  workflow_call:

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # Ensure this job has the necessary permissions
    permissions:
      contents: read
      id-token: write  # For enhanced security
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Shallow clone for faster checkout
          fetch-depth: 1
      
      # üå± MEASURE CARBON FOOTPRINT - Core metrics collection
      - name: Measure Carbon Footprint
        uses: EcoStackTech/metrics@v8.1.2
        # This action provides:
        # ‚Ä¢ True pipeline duration measurement (from commit/PR creation)
        # ‚Ä¢ Enhanced resource monitoring (CPU, memory, disk, network)
        # ‚Ä¢ Energy consumption data for API-side carbon calculations
        # ‚Ä¢ Pipeline efficiency insights
        # ‚Ä¢ Unified metrics structure for dashboard aggregation
        # ‚Ä¢ Common metrics (entity ID, location, category, department)
        # ‚Ä¢ Automatic API transmission to EcoStack
      
      # Optional: Post-metrics collection steps
      - name: Post-metrics summary
        if: always()
        run: |
          echo "üìã Metrics collection summary:"
          echo "   ‚Ä¢ Repository: ${{ github.repository }}"
          echo "   ‚Ä¢ Workflow: ${{ github.workflow }}"
          echo "   ‚Ä¢ Job: ${{ github.job }}"
          echo "   ‚Ä¢ Run ID: ${{ github.run_id }}"
          echo "   ‚Ä¢ Runner: ${{ runner.name }}"
          echo "   ‚Ä¢ Event: ${{ github.event_name }}"
          echo ""
          echo "‚úÖ Metrics sent to EcoStack API successfully!"
          echo "üå± Your environmental impact has been measured and recorded."
      
      # Optional: Add any post-processing or notifications
      - name: Notify team (optional)
        if: always() && github.event_name == 'push'
        run: |
          echo "üîî Metrics collection completed for ${{ github.repository }}"
          echo "üìä Check your EcoStack dashboard for detailed insights"
          echo "üåç Help your team reduce their carbon footprint!"

# Example usage in any repository:
#
# name: Use EcoStack Metrics
# on: [push, pull_request]
# jobs:
#   metrics:
#     uses: ./.github/workflows/ecostack-metrics.yml
#
#   # Your other jobs...
#   build:
#     needs: metrics
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - run: echo "Building after metrics collection..."
